<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engram â€” Analytics Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #0f0f18;
  --bg-card: #12121e;
  --bg-card-hover: #18182a;
  --border: #1e1e35;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a8;
  --text-muted: #55556a;
  --purple: #6B46C1;
  --purple-light: #8B5CF6;
  --cyan: #06B6D4;
  --cyan-light: #22D3EE;
  --green: #10B981;
  --red: #EF4444;
  --yellow: #F59E0B;
  --gradient: linear-gradient(135deg, var(--purple), var(--cyan));
  --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
}

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
.gradient-text { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

/* Nav */
nav {
  padding: 16px 0;
  background: #0a0a0fcc;
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 24px;
}

.nav-logo {
  font-size: 1.3rem;
  font-weight: 800;
  text-decoration: none;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.nav-logo .logo-icon {
  width: 28px;
  height: 28px;
  background: var(--gradient);
  border-radius: 6px;
}

.nav-links { display: flex; gap: 20px; align-items: center; }
.nav-links a {
  text-decoration: none;
  color: var(--text-secondary);
  font-size: 0.85rem;
  font-weight: 500;
  transition: color 0.2s;
}
.nav-links a:hover { color: var(--text-primary); }
.nav-links a.active { color: var(--cyan); }

.btn-logout {
  padding: 6px 16px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-secondary);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--font-sans);
}
.btn-logout:hover { border-color: var(--red); color: var(--red); }

/* Login redirect */
.login-prompt {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 65px);
  text-align: center;
}

.login-prompt h2 { font-size: 1.5rem; margin-bottom: 12px; }
.login-prompt p { color: var(--text-secondary); margin-bottom: 24px; }
.login-prompt a {
  display: inline-block;
  padding: 12px 32px;
  background: var(--gradient);
  border-radius: 12px;
  color: white;
  text-decoration: none;
  font-weight: 600;
}

/* Dashboard layout */
.dashboard { display: none; padding: 32px 0 64px; }

.dash-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.dash-header h1 { font-size: 1.8rem; font-weight: 800; }

.controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.controls select {
  padding: 8px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 0.8rem;
  cursor: pointer;
  outline: none;
}
.controls select:focus { border-color: var(--purple); }

.tier-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 16px;
  border-radius: 100px;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.tier-free { background: #1e1e35; color: var(--text-secondary); }
.tier-pro { background: linear-gradient(135deg, #6B46C130, #06B6D430); color: var(--cyan-light); border: 1px solid var(--purple); }
.tier-enterprise { background: linear-gradient(135deg, #F59E0B20, #EF444420); color: var(--yellow); border: 1px solid var(--yellow); }

/* Stats row */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.stat-item {
  padding: 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  text-align: center;
}

.stat-item .value {
  font-size: 1.8rem;
  font-weight: 800;
  margin-bottom: 4px;
}

.stat-item .label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Charts grid */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 28px;
}

.chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
}

.chart-card h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
}

.chart-wrapper {
  position: relative;
  height: 250px;
}

/* Tables grid */
.tables-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.table-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  overflow: hidden;
}

.table-card h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 16px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.data-table th {
  text-align: left;
  padding: 10px 12px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  font-weight: 600;
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #1e1e3520;
  color: var(--text-secondary);
}

.data-table tr:last-child td { border-bottom: none; }

.data-table .tag-name {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  color: var(--cyan);
}

.data-table .ns-name {
  font-weight: 600;
  color: var(--text-primary);
}

.data-table .count {
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--text-primary);
}

.tag-bar {
  height: 6px;
  background: var(--gradient);
  border-radius: 3px;
  margin-top: 4px;
  transition: width 0.3s ease;
}

.empty-state {
  text-align: center;
  padding: 32px;
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* Pro gate overlay */
.pro-gate {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(10, 10, 15, 0.95);
  align-items: center;
  justify-content: center;
  text-align: center;
}
.pro-gate.active { display: flex; }
.pro-gate h2 { font-size: 1.5rem; margin-bottom: 12px; }
.pro-gate p { color: var(--text-secondary); margin-bottom: 24px; max-width: 400px; }
.pro-gate a {
  display: inline-block;
  padding: 12px 32px;
  background: var(--gradient);
  border-radius: 12px;
  color: white;
  text-decoration: none;
  font-weight: 600;
}

/* Loading */
.loading { opacity: 0.5; }

/* Responsive */
@media (max-width: 768px) {
  .charts-grid, .tables-grid { grid-template-columns: 1fr; }
  .chart-wrapper { height: 200px; }
  .dash-header { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<!-- Nav -->
<nav>
  <div class="nav-inner">
    <a href="/" class="nav-logo">
      <div class="logo-icon"></div>
      engram
    </a>
    <div class="nav-links" id="navAuth" style="display:none">
      <a href="/">Home</a>
      <a href="/account.html">Account</a>
      <a href="/analytics.html" class="active">Analytics</a>
      <button class="btn-logout" onclick="logout()">Log out</button>
    </div>
  </div>
</nav>

<!-- Login prompt (shown when not authenticated) -->
<div class="login-prompt" id="loginPrompt">
  <div>
    <h2>Analytics <span class="gradient-text">Dashboard</span></h2>
    <p>Sign in to view your memory analytics.</p>
    <a href="/account.html">Sign In</a>
  </div>
</div>

<!-- Pro gate (shown for free tier) -->
<div class="pro-gate" id="proGate">
  <div>
    <h2>Pro <span class="gradient-text">Feature</span></h2>
    <p>The Analytics Dashboard is available on the Pro plan. Upgrade to unlock memory insights, growth charts, and more.</p>
    <a href="/#pricing">Upgrade to Pro</a>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <div class="container">
    <div class="dash-header">
      <div>
        <h1>Analytics <span class="gradient-text">Dashboard</span></h1>
      </div>
      <div class="controls">
        <span class="tier-badge" id="tierBadge"></span>
        <select id="periodSelect" onchange="loadAnalytics()">
          <option value="30">Last 30 days</option>
          <option value="90" selected>Last 90 days</option>
          <option value="180">Last 6 months</option>
          <option value="365">Last year</option>
        </select>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-item">
        <div class="value gradient-text" id="statTotal">-</div>
        <div class="label">Total Memories</div>
      </div>
      <div class="stat-item">
        <div class="value gradient-text" id="statNamespaces">-</div>
        <div class="label">Namespaces</div>
      </div>
      <div class="stat-item">
        <div class="value gradient-text" id="statTypes">-</div>
        <div class="label">Memory Types</div>
      </div>
      <div class="stat-item">
        <div class="value gradient-text" id="statTags">-</div>
        <div class="label">Unique Tags</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Memory Growth</h3>
        <div class="chart-wrapper">
          <canvas id="growthChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Importance Distribution</h3>
        <div class="chart-wrapper">
          <canvas id="distChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tables -->
    <div class="tables-grid">
      <div class="table-card">
        <h3>Top Tags</h3>
        <table class="data-table" id="tagsTable">
          <thead>
            <tr><th>Tag</th><th>Count</th><th></th></tr>
          </thead>
          <tbody id="tagsBody">
            <tr><td colspan="3" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>Namespaces</h3>
        <table class="data-table" id="nsTable">
          <thead>
            <tr><th>Namespace</th><th>Memories</th><th>Avg Importance</th></tr>
          </thead>
          <tbody id="nsBody">
            <tr><td colspan="3" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Types breakdown -->
    <div class="charts-grid" style="margin-top: 20px">
      <div class="chart-card">
        <h3>Memory Types</h3>
        <div class="chart-wrapper">
          <canvas id="typesChart"></canvas>
        </div>
      </div>
      <div class="table-card">
        <h3>Types Breakdown</h3>
        <table class="data-table">
          <thead>
            <tr><th>Type</th><th>Count</th><th>%</th></tr>
          </thead>
          <tbody id="typesBody">
            <tr><td colspan="3" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const API = 'https://api.engram-ai.dev';
let token = localStorage.getItem('engram_token');
let refreshToken = localStorage.getItem('engram_refresh');
let growthChart = null;
let distChart = null;
let typesChart = null;

// Chart.js defaults for dark theme
Chart.defaults.color = '#8888a8';
Chart.defaults.borderColor = '#1e1e35';
Chart.defaults.font.family = "'Inter', system-ui, sans-serif";

// Init
if (token) {
  initDashboard();
} else {
  document.getElementById('loginPrompt').style.display = 'flex';
}

async function initDashboard() {
  document.getElementById('loginPrompt').style.display = 'none';
  document.getElementById('navAuth').style.display = 'flex';

  // Check tier first
  const resp = await apiFetch('/v1/auth/me');
  if (!resp) return;
  const user = await resp.json();

  const badge = document.getElementById('tierBadge');
  badge.textContent = user.tier.toUpperCase();
  badge.className = 'tier-badge tier-' + user.tier;

  if (!user.limits?.analytics) {
    document.getElementById('proGate').classList.add('active');
    return;
  }

  document.getElementById('dashboard').style.display = 'block';
  await loadAnalytics();
}

async function apiFetch(path, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['Authorization'] = 'Bearer ' + token;
  let resp = await fetch(API + path, opts);

  if (resp.status === 401 && refreshToken) {
    const refreshResp = await fetch(API + '/v1/auth/refresh', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh_token: refreshToken }),
    });
    if (refreshResp.ok) {
      const data = await refreshResp.json();
      token = data.access_token;
      refreshToken = data.refresh_token;
      localStorage.setItem('engram_token', token);
      localStorage.setItem('engram_refresh', refreshToken);
      opts.headers['Authorization'] = 'Bearer ' + token;
      resp = await fetch(API + path, opts);
    } else {
      logout();
      return null;
    }
  }

  if (resp.status === 401) { logout(); return null; }
  return resp;
}

async function loadAnalytics() {
  const days = document.getElementById('periodSelect').value;
  const resp = await apiFetch('/v1/analytics?days=' + days);
  if (!resp) return;

  if (resp.status === 403) {
    document.getElementById('proGate').classList.add('active');
    return;
  }

  const data = await resp.json();
  renderStats(data);
  renderGrowthChart(data.growth);
  renderDistChart(data.distribution);
  renderTypesChart(data.types);
  renderTagsTable(data.tags);
  renderNamespacesTable(data.namespaces);
  renderTypesTable(data.types, data.total_memories);
}

function renderStats(data) {
  document.getElementById('statTotal').textContent = data.total_memories.toLocaleString();
  document.getElementById('statNamespaces').textContent = data.namespaces.length;
  document.getElementById('statTypes').textContent = Object.keys(data.types).length;
  document.getElementById('statTags').textContent = data.tags.length;
}

function renderGrowthChart(growth) {
  const ctx = document.getElementById('growthChart').getContext('2d');

  // Build cumulative data
  let cumulative = 0;
  const labels = growth.map(g => g.date);
  const dailyData = growth.map(g => g.count);
  const cumulativeData = growth.map(g => { cumulative += g.count; return cumulative; });

  if (growthChart) growthChart.destroy();
  growthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Cumulative',
          data: cumulativeData,
          borderColor: '#06B6D4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHitRadius: 10,
          borderWidth: 2,
        },
        {
          label: 'Daily',
          data: dailyData,
          borderColor: '#6B46C1',
          backgroundColor: 'rgba(107, 70, 193, 0.3)',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHitRadius: 10,
          borderWidth: 2,
          yAxisID: 'y1',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: true, position: 'top', labels: { boxWidth: 12, padding: 16, font: { size: 11 } } },
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { maxTicksLimit: 8, font: { size: 10 } },
        },
        y: {
          position: 'left',
          grid: { color: '#1e1e3540' },
          ticks: { font: { size: 10 } },
          title: { display: true, text: 'Total', font: { size: 10 } },
        },
        y1: {
          position: 'right',
          grid: { display: false },
          ticks: { font: { size: 10 } },
          title: { display: true, text: 'Daily', font: { size: 10 } },
        },
      },
    },
  });
}

function renderDistChart(distribution) {
  const ctx = document.getElementById('distChart').getContext('2d');
  const labels = [];
  const values = [];
  for (let i = 1; i <= 10; i++) {
    labels.push(i.toString());
    values.push(distribution[i] || 0);
  }

  const colors = labels.map((_, i) => {
    const ratio = i / 9;
    const r = Math.round(107 + (6 - 107) * ratio);
    const g = Math.round(70 + (182 - 70) * ratio);
    const b = Math.round(193 + (212 - 193) * ratio);
    return `rgb(${r}, ${g}, ${b})`;
  });

  if (distChart) distChart.destroy();
  distChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Memories',
        data: values,
        backgroundColor: colors,
        borderRadius: 6,
        borderSkipped: false,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          grid: { display: false },
          title: { display: true, text: 'Importance', font: { size: 10 } },
        },
        y: {
          grid: { color: '#1e1e3540' },
          ticks: { font: { size: 10 } },
        },
      },
    },
  });
}

function renderTypesChart(types) {
  const ctx = document.getElementById('typesChart').getContext('2d');
  const labels = Object.keys(types);
  const values = Object.values(types);

  const typeColors = {
    fact: '#06B6D4',
    preference: '#8B5CF6',
    decision: '#10B981',
    error_fix: '#EF4444',
    pattern: '#F59E0B',
    workflow: '#EC4899',
    summary: '#6366F1',
    custom: '#8888a8',
  };

  const colors = labels.map(l => typeColors[l] || '#8888a8');

  if (typesChart) typesChart.destroy();
  typesChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: '#12121e',
        borderWidth: 3,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'right',
          labels: { boxWidth: 12, padding: 12, font: { size: 11 } },
        },
      },
    },
  });
}

function renderTagsTable(tags) {
  const body = document.getElementById('tagsBody');
  if (tags.length === 0) {
    body.innerHTML = '<tr><td colspan="3" class="empty-state">No tags found</td></tr>';
    return;
  }

  const maxCount = tags[0]?.count || 1;
  body.innerHTML = tags.slice(0, 15).map(t => `
    <tr>
      <td><span class="tag-name">${escHtml(t.tag)}</span></td>
      <td><span class="count">${t.count}</span></td>
      <td style="width:40%"><div class="tag-bar" style="width:${Math.round(t.count / maxCount * 100)}%"></div></td>
    </tr>
  `).join('');
}

function renderNamespacesTable(namespaces) {
  const body = document.getElementById('nsBody');
  if (namespaces.length === 0) {
    body.innerHTML = '<tr><td colspan="3" class="empty-state">No namespaces</td></tr>';
    return;
  }

  body.innerHTML = namespaces.map(ns => `
    <tr>
      <td><span class="ns-name">${escHtml(ns.namespace)}</span></td>
      <td><span class="count">${ns.count.toLocaleString()}</span></td>
      <td>${ns.avg_importance ?? '-'}</td>
    </tr>
  `).join('');
}

function renderTypesTable(types, total) {
  const body = document.getElementById('typesBody');
  const entries = Object.entries(types).sort((a, b) => b[1] - a[1]);
  if (entries.length === 0) {
    body.innerHTML = '<tr><td colspan="3" class="empty-state">No data</td></tr>';
    return;
  }

  body.innerHTML = entries.map(([type, count]) => `
    <tr>
      <td><span class="ns-name">${escHtml(type)}</span></td>
      <td><span class="count">${count}</span></td>
      <td>${total > 0 ? Math.round(count / total * 100) : 0}%</td>
    </tr>
  `).join('');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function logout() {
  localStorage.removeItem('engram_token');
  localStorage.removeItem('engram_refresh');
  window.location.href = '/account.html';
}
</script>
</body>
</html>
